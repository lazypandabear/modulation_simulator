<!DOCTYPE html>
<html>
<head>
    <title>Modulator Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <form method="POST">
        <div style="border:1px solid #ccc; padding:10px;">
            <h3>Input Section</h3>
            <label>Type of Digital Modulation:</label><br>
            <input type="radio" name="mod_type" value="QAM"  {% if mod_type == 'QAM' %}checked{% endif %}> QAM<br>
            <input type="radio" name="mod_type" value="PSK"  {% if mod_type == 'PSK' %}checked{% endif %}> PSK<br>
            <input type="radio" name="mod_type" value="FSK"  {% if mod_type == 'FSK' %}checked{% endif %}> FSK<br>
            <input type="radio" name="mod_type" value="ASK"  {% if mod_type == 'ASK' %}checked{% endif %}> ASK<br>
            <input type="radio" name="mod_type" value="CSS"  {% if mod_type == 'CSS' %}checked{% endif %}> CSS<br><br>

            <label>Modulation Order (2^x):</label>
            <select name="mod_order">
                {% for val in [2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,65536] %}
                    <option value="{{val}}" {% if mod_order == val %}selected{% endif %}>{{val}}</option>
                {% endfor %}
            </select><br><br>

            <label>SNR (dB):</label><br>
            <input type="number" step="0.01" name="snr" value="{{snr}}"><br><br>

            <label>Target Data Rate (Mbps):</label><br>
            <input type="number" step="0.01" name="target_data_rate" value="{{target_data_rate}}"><br><br>

            <label>Sample Data Stream (bits):</label><br>
            <input type="text" name="sample_data" value="{{sample_data}}"><br><br>

            <label>Auto Compute:</label>
            <input type="checkbox" name="auto_compute" {% if auto_compute %}checked{% endif %}
                   onchange="this.form.submit()">
            <br><br>

            <button type="submit">Run Simulation</button>
        </div>
    </form>
    <div style="border:1px solid #ccc; padding:10px; margin-top:10px;">
        <h3>Result Section</h3>
        <div style="display:flex; justify-content:space-around;">
            <div>
                <h4>Calculated Value</h4>
                {% if calc_values.error %}
                    <p style="color:red;">{{calc_values.error}}</p>
                {% else %}
                    <ul>
                    {% for key, val in calc_values.items() %}
                        {% if key != 'error' %}
                            <li><strong>{{key}}:</strong> {{val}}</li>
                        {% endif %}
                    {% endfor %}
                    </ul>
                {% endif %}
            </div>
            <div>
                <h4>Standard Value</h4>
                <ul>
                {% for key, val in standard_values.items() %}
                    <li><strong>{{key}}:</strong> {{val}}</li>
                {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div style="border:1px solid #ccc; padding:10px; margin-top:10px;">
        <h3>Chart Section</h3>
        <canvas id="timeDomainChart"></canvas>
        <canvas id="freqChart"></canvas>
        <canvas id="berSNRChart"></canvas>
        <canvas id="constellationChart"></canvas>
        <canvas id="noiseChart"></canvas>
    </div>

    <script>
        // Time Domain
        var timeCtx = document.getElementById('timeDomainChart').getContext('2d');
        var timeData = {{ time_domain_data|safe }};
        var timeLabels = [];
        for(var i=0; i<timeData.length; i++){
            timeLabels.push(i);
        }
        new Chart(timeCtx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Time Domain Signal',
                    data: timeData,
                    borderColor: 'blue',
                    fill: false
                }]
            }
        });

        // Frequency Spectrum
        var freqCtx = document.getElementById('freqChart').getContext('2d');
        var freqData = {{ freq_data|safe }};
        var freqLabels = freqData.map(d => d.freq);
        var freqAmps = freqData.map(d => d.amp);
        new Chart(freqCtx, {
            type: 'bar',
            data: {
                labels: freqLabels,
                datasets: [{
                    label: 'Spectrum Amplitude',
                    data: freqAmps,
                    backgroundColor: 'orange'
                }]
            }
        });

        // BER vs SNR
        var berCtx = document.getElementById('berSNRChart').getContext('2d');
        var berData = {{ ber_snr_data|safe }};
        var snrLabels = berData.map(d => d.snr);
        var berVals = berData.map(d => d.ber);
        new Chart(berCtx, {
            type: 'line',
            data: {
                labels: snrLabels,
                datasets: [{
                    label: 'BER vs SNR',
                    data: berVals,
                    borderColor: 'green',
                    fill: false
                }]
            },
            options: {
                scales: {
                    y: {
                        type: 'logarithmic'
                    }
                }
            }
        });

        // Constellation
        var constCtx = document.getElementById('constellationChart').getContext('2d');
        var constData = {{ constellation_data|safe }};
        var scatterData = constData.map(point => ({x: point.x, y: point.y}));
        new Chart(constCtx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Constellation',
                    data: scatterData,
                    pointBackgroundColor: 'red'
                }]
            },
            options: {
                scales: {
                    x: { min: -2, max: 2 },
                    y: { min: -2, max: 2 }
                }
            }
        });

        // Acceptable Noise Level
        var noiseCtx = document.getElementById('noiseChart').getContext('2d');
        var noiseData = {{ noise_data|safe }};
        var noiseScatter = noiseData.map(n => ({x: n.x, y: n.y}));
        new Chart(noiseCtx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Noise Boundary',
                    data: noiseScatter,
                    pointBackgroundColor: 'purple'
                }]
            },
            options: {
                scales: {
                    x: { min: -2, max: 2 },
                    y: { min: -2, max: 2 }
                }
            }
        });

        // Auto compute on input changes
        document.querySelectorAll('input[type="number"], input[type="text"], select').forEach(el => {
            el.addEventListener('change', () => {
                var autoCompute = document.querySelector('input[name="auto_compute"]');
                if(autoCompute && autoCompute.checked) {
                    document.forms[0].submit();
                }
            });
        });
    </script>
</body>
</html>
