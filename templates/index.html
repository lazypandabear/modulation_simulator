<!DOCTYPE html>
<html>
<head>
    <title>Modulator Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        .input-section {
            padding: 10px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }
        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 10px;
        }
        .input-grid label,
        .input-grid input,
        .input-grid select {
            width: 100%;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .chart-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .chart-box {
            width: 48%;
            margin-bottom: 20px;
        }
        .chart-box canvas {
            width: 100%;
            height: 300px;
        }
        .chart-row {
            display: flex;
            justify-content: space-between;
        }
        .chart-row .chart-box {
            width: 48%;
        }
        /* Align radio bullets with labels */
        .radio-label {
            display: flex;             /* align radio button and label horizontally */
            align-items: center;      /* vertically center the label and radio button */
            justify-content: flex-start; /* left-align them horizontally */
            margin: 2px 0;
          }
        .radio-label input[type="radio"] {
          margin-right: 5px;
        }
        .radio-label label {
          margin-left: 5px;
        }
    </style>
</head>
<body>
    <form method="POST">
        <div class="input-section">
            <h3>Input Section</h3>
            <div class="input-grid">
                <!-- Left Column: Modulation type (aligned bullets) -->
                <div>
                    <label>Type of Digital Modulation:</label><br>
                    <label class="radio-label">
                        <input type="radio" name="mod_type" value="QAM"  {% if mod_type == 'QAM' %}checked{% endif %}>
                        QAM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="mod_type" value="PSK"  {% if mod_type == 'PSK' %}checked{% endif %}>
                        PSK
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="mod_type" value="FSK"  {% if mod_type == 'FSK' %}checked{% endif %}>
                        FSK
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="mod_type" value="ASK"  {% if mod_type == 'ASK' %}checked{% endif %}>
                        ASK
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="mod_type" value="CSS"  {% if mod_type == 'CSS' %}checked{% endif %}>
                        CSS
                    </label>
                </div>

                <!-- Right Column: Order, SNR, and Target Data Rate -->
                <div>
                    <label>Modulation Order (2^x):</label>
                    <select name="mod_order">
                        {% for val in [2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,65536] %}
                            <option value="{{val}}" {% if mod_order == val %}selected{% endif %}>{{val}}</option>
                        {% endfor %}
                    </select>
                    <label>SNR (dB):</label>
                    <input type="number" step="0.01" name="snr" value="{{snr}}">

                    <label>Target Data Rate (Mbps):</label>
                    <input type="number" step="0.01" name="target_data_rate" value="{{target_data_rate}}">
                </div>

                <!-- Full width: Sample Data -->
                <div class="full-width">
                    <label>Sample Data Stream (bits):</label>
                    <input type="text" name="sample_data" value="{{sample_data}}">
                </div>
                <!-- Full width: Auto Compute and Button -->
                <div class="full-width">
                    <label>Auto Compute:</label>
                    <input type="checkbox" name="auto_compute" {% if auto_compute %}checked{% endif %}
                           onchange="this.form.submit()">
                    <button type="submit">Run Simulation</button>
                </div>
            </div>
        </div>
    </form>

    <div style="border:1px solid #ccc; padding:10px;">
        <h3>Result Section</h3>
        <div style="display:flex; justify-content:space-around;">
            <div>
                <h4>Calculated Value</h4>
                {% if calc_values.error %}
                    <p style="color:red;">{{calc_values.error}}</p>
                {% else %}
                    <ul>
                    {% for key, val in calc_values.items() %}
                        {% if key != 'error' %}
                            <li><strong>{{key}}:</strong> {{val}}</li>
                        {% endif %}
                    {% endfor %}
                    </ul>
                {% endif %}
            </div>
            <div>
                <h4>Standard Value</h4>
                <ul>
                {% for key, val in standard_values.items() %}
                    <li><strong>{{key}}:</strong> {{val}}</li>
                {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div style="border:1px solid #ccc; padding:10px; margin-top:10px;">
        <h3>Chart Section</h3>

        <!-- 2x2 Grid for four charts -->
        <div class="chart-container">
            <!-- Time Domain Chart with Time Axis -->
            <div class="chart-box">
                <canvas id="timeDomainChart"></canvas>
            </div>
            <!-- Frequency Spectrum Chart (Welch) -->
            <div class="chart-box">
                <canvas id="freqChart"></canvas>
            </div>
            <!-- BER vs SNR Chart -->
            <div class="chart-box">
                <canvas id="berSNRChart"></canvas>
            </div>
            <!-- Constellation Chart -->
            <div class="chart-box">
              <canvas id="snrThroughputChart"></canvas>
                
            </div>
        </div>

        <!-- Row for Noise and SNR-vs-Throughput Charts -->
        <div class="chart-row">
            <div class="chart-box">
                <canvas id="noiseChart"></canvas>
            </div>
            <div class="chart-box">
              <canvas id="constellationChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Time Domain Chart
        const timeData = {{ time_domain_data|safe }};
        const timeValues = {{ time_values|safe }};
        const timeCtx = document.getElementById('timeDomainChart').getContext('2d');
        new Chart(timeCtx, {
            type: 'line',
            data: {
                labels: timeValues,
                datasets: [{
                    label: 'Time Domain Signal (Time in sec)',
                    data: timeData,
                    borderColor: 'blue',
                    fill: false
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: { display: true } },
                scales: {
                    x: { title: { display: true, text: 'Time (s)' } },
                    y: { title: { display: true, text: 'Amplitude' } }
                }
            }
        });

        // Frequency Spectrum Chart
        // freqData => array of objects {freq, amp}, amp is in dB/Hz
        const freqDataRaw = {{ freq_data|safe }};
        const freqLabels = freqDataRaw.map(d => d.freq);
        const freqVals = freqDataRaw.map(d => d.amp);
        const freqCtx = document.getElementById('freqChart').getContext('2d');
        new Chart(freqCtx, {
            type: 'line',
            data: {
                labels: freqLabels,
                datasets: [{
                    label: 'Power Spectral Density (dB/Hz)',
                    data: freqVals,
                    borderColor: 'orange',
                    fill: false
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: { display: true } },
                scales: {
                    x: { title: { display: true, text: 'Frequency (Hz)' } },
                    y: { title: { display: true, text: 'PSD (dB/Hz)' } }
                }
            }
        });

        // BER vs SNR Chart
        const berData = {{ ber_snr_data|safe }};
        const berLabels = berData.map(d => d.snr);
        const berVals = berData.map(d => d.ber);
        const berCtx = document.getElementById('berSNRChart').getContext('2d');
        new Chart(berCtx, {
            type: 'line',
            data: {
                labels: berLabels,
                datasets: [{
                    label: 'BER vs. SNR',
                    data: berVals,
                    borderColor: 'green',
                    fill: false
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: { display: true } },
                scales: {
                    x: { title: { display: true, text: 'SNR (dB)' } },
                    y: {
                        type: 'logarithmic',
                        title: { display: true, text: 'Bit Error Rate' }
                    }
                }
            }
        });

        // SNR vs. Throughput Chart
        const snrThrData = {{ snr_throughput_data|safe }};
        const snrThrLabels = snrThrData.map(d => d.snr);
        const thrVals = snrThrData.map(d => d.throughput);
        const snrThrCtx = document.getElementById('snrThroughputChart').getContext('2d');
        new Chart(snrThrCtx, {
            type: 'line',
            data: {
                labels: snrThrLabels,
                datasets: [{
                    label: 'SNR vs. Throughput',
                    data: thrVals,
                    borderColor: 'blue',
                    fill: false
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: { display: true } },
                scales: {
                    x: { title: { display: true, text: 'SNR (dB)' } },
                    y: { title: { display: true, text: 'Throughput (Mbps)' } }
                }
            }
        });

        // Constellation Chart
        const constData = {{ constellation_data|safe }};
        const scatterData = constData.map(point => ({x: point.x, y: point.y}));
        // Cross lines
        const crossLines = [
            {
                label: 'Horizontal Axis',
                type: 'line',
                data: [{x: -2, y: 0}, {x: 2, y: 0}],
                borderColor: 'black',
                borderDash: [5, 5],
                fill: false,
                pointRadius: 0
            },
            {
                label: 'Vertical Axis',
                type: 'line',
                data: [{x: 0, y: -2}, {x: 0, y: 2}],
                borderColor: 'black',
                borderDash: [5, 5],
                fill: false,
                pointRadius: 0
            }
        ];
        const constCtx = document.getElementById('constellationChart').getContext('2d');
        new Chart(constCtx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: 'Constellation Points',
                        data: scatterData,
                        pointBackgroundColor: 'red'
                    }
                ].concat(crossLines)
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: { display: true } },
                scales: {
                    x: { min: -2, max: 2, title: { display: true, text: 'In-Phase' } },
                    y: { min: -2, max: 2, title: { display: true, text: 'Quadrature' } }
                }
            }
        });

        // Noise Boundary Chart
        // noiseData => array of objects:
        //    { label: "Tolerance Circle i", center: {x, y}, points: [ {x, y}, ..., {x, y} ] }
        const noiseRaw = {{ noise_data|safe }};
        const noiseDatasets = [];
        noiseRaw.forEach(obj => {
            // Circle points
            noiseDatasets.push({
                label: obj.label,
                data: obj.points.map(p => ({x: p.x, y: p.y})),
                showLine: true,
                borderColor: 'purple',
                backgroundColor: 'rgba(0,0,0,0)',  // no fill
                pointRadius: 0
            });
            // Center point
            noiseDatasets.push({
                label: 'Center ' + obj.label,
                data: [{x: obj.center.x, y: obj.center.y}],
                pointBackgroundColor: 'purple',
                pointRadius: 3,
                showLine: false
            });
        });
        const noiseCtx = document.getElementById('noiseChart').getContext('2d');
        new Chart(noiseCtx, {
            type: 'scatter',
            data: {
                datasets: noiseDatasets
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: { display: true } },
                scales: {
                    x: { min: -2, max: 2, title: { display: true, text: 'X' } },
                    y: { min: -2, max: 2, title: { display: true, text: 'Y' } }
                }
            }
        });

        

        // Auto compute on changes
        document.querySelectorAll('input[type="number"], input[type="text"], select').forEach(el => {
            el.addEventListener('change', () => {
                var autoCompute = document.querySelector('input[name="auto_compute"]');
                if(autoCompute && autoCompute.checked) {
                    document.forms[0].submit();
                }
            });
        });
    </script>
</body>
</html>
